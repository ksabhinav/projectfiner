<style>

.finer-news-container{
    font-family: Georgia, "Times New Roman", serif;
    max-width: 420px;
    margin: 0;
}

/* Header */

.finer-news-header{
    font-size: .95rem;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: #666;
    margin-bottom: 1.2rem;
}

/* Items */

.finer-news-item{
    padding: .9rem 0;
    border-bottom: 1px solid #e6e6e6;
}

.finer-news-item:last-child{
    border-bottom: none;
}

/* Meta */

.finer-news-meta{
    font-size: .75rem;
    color: #8a8a8a;
    margin-bottom: .25rem;
}

.finer-news-category{
    margin-left: .4rem;
}

/* Title */

.finer-news-title{
    font-size: .98rem;
    font-weight: 500;
    margin: .1rem 0;
    line-height: 1.45;
}

.finer-news-title a{
    color: #222;
    text-decoration: none;
}

.finer-news-title a:hover{
    text-decoration: underline;
}

/* Source */

.finer-news-source{
    font-size: .78rem;
    color: #9a9a9a;
    margin-top: .15rem;
}

/* States */

.finer-news-loading,
.finer-news-empty{
    color:#8a8a8a;
    font-size:.9rem;
    padding:.5rem 0;
}

</style>



<div class="finer-news-container">

    <div class="finer-news-header">
        Latest News
    </div>

    <div id="finer-news-content" class="finer-news-loading">
        Loading latest news…
    </div>

</div>



<script>
(function(){

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzzD3DGWjt8ttHoWnQSa9X0CnhLcLhN7ovf_BSCDHj6rywlOQY-CBIaz5hqN5zPcgp13w/exec";

const CACHE_KEY = "finer_news_cache";
const CACHE_TIME = 15 * 60 * 1000;


/* CACHE */

function loadFromCache(){

    const cached = localStorage.getItem(CACHE_KEY);

    if(!cached) return false;

    const parsed = JSON.parse(cached);

    if(Date.now() - parsed.timestamp > CACHE_TIME){
        return false;
    }

    renderNews(parsed.data);
    return true;
}


/* FETCH */

async function fetchWithTimeout(url, timeout = 6000){

    const controller = new AbortController();

    const id = setTimeout(()=>controller.abort(), timeout);

    const response = await fetch(url,{
        signal: controller.signal,
        cache:"no-store"
    });

    clearTimeout(id);

    if(!response.ok){
        throw new Error(`HTTP ${response.status}`);
    }

    return response.json();
}


async function loadNews(){

    const container = document.getElementById("finer-news-content");

    try{

        const data = await fetchWithTimeout(WEB_APP_URL);

        localStorage.setItem(CACHE_KEY, JSON.stringify({
            timestamp: Date.now(),
            data: data
        }));

        renderNews(data);

    }catch(err){

        console.error(err);

        if(!loadFromCache()){
            container.innerHTML = `
                <div class="finer-news-empty">
                    Unable to load news right now.
                </div>
            `;
        }
    }
}


/* RENDER */

function renderNews(data){

    const container = document.getElementById("finer-news-content");

    if(!data.news || data.news.length === 0){
        container.innerHTML = `
            <div class="finer-news-empty">
                No approved news items yet.
            </div>`;
        return;
    }

    const html = data.news.map(item=>{

        const date = formatDate(item.date);

        return `
        <article class="finer-news-item">

            <div class="finer-news-meta">
                ${date}
                ${item.category ? `<span class="finer-news-category">• ${item.category}</span>`:''}
            </div>

            <div class="finer-news-title">
                <a href="${item.url}" target="_blank" rel="noopener">
                    ${item.title}
                </a>
            </div>

            ${item.source ? `<div class="finer-news-source">${item.source}</div>`:''}

        </article>
        `;
    }).join("");

    container.innerHTML = html;
}


function formatDate(dateString){

    if(!dateString) return "Recent";

    const date = new Date(dateString);

    if(isNaN(date)) return "Recent";

    return date.toLocaleDateString("en-GB",{
        day:"numeric",
        month:"short",
        year:"numeric"
    });
}


/* INIT */

if(!loadFromCache()){
    loadNews();
}else{
    setTimeout(loadNews, 2000);
}

setInterval(loadNews, CACHE_TIME);

})();
</script>
